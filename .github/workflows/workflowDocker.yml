name: Construcción y Publicación de Imagen Docker
on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  build-and-push-docker-image:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3


      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}


      - name: Build and tag Docker image
        id: build-image
        env:
          DOCKER_IMAGE_NAME: HealthCareR
        run: |
          # Creamos una etiqueta única basada en el hash del commit.
          # Esto nos permite mantener un historial de versiones exacto.
          IMAGE_TAG=${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          
          # Construimos la imagen y le asignamos la etiqueta única.
          echo "Building image with tag: $IMAGE_TAG"
          docker build -t $IMAGE_TAG .
          
          # Creamos un alias 'dev' que apunta a la misma imagen.
          # Esto nos permite referenciar la última versión de desarrollo de forma sencilla.
          DEV_TAG=${{ env.DOCKER_IMAGE_NAME }}:dev
          echo "Tagging image as: $DEV_TAG"
          docker tag $IMAGE_TAG $DEV_TAG

          # Guardamos las etiquetas en un archivo de salida para los siguientes pasos
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "DEV_TAG=$DEV_TAG" >> $GITHUB_OUTPUT


      - name: Push the images
        env:
          DOCKER_IMAGE_TAGS: ${{ steps.build-image.outputs.IMAGE_TAG }},${{ steps.build-image.outputs.DEV_TAG }}
        run: |
          echo "Pushing images to Docker Hub"
          docker push $DOCKER_IMAGE_TAGS
